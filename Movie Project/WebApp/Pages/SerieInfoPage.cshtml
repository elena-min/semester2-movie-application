@page
@using DAL;
@using LogicLayer.Classes;
@using LogicLayer.Controllers;
@using LogicLayer.Interfaces;
@model WebApp.Pages.SerieInfoPageModel
@{
    Layout = "_LayoutMain";
    @functions {
        static IReviewDAL iReviewDAL = new ReviewDAL();
        static ReviewController reviewController = new ReviewController(iReviewDAL);
        static IMediaItemDAL iMediaItemDAL = new MediaItemDAL();
        static MediaItemController mediaController = new MediaItemController(iMediaItemDAL);
        static IUserDAL iuserDAL = new UserDAL();
        static UserController userController = new UserController(iuserDAL);
    }
}

@if (TempData["Message"] != null)
{
    <div class="alert alert-success">@TempData["Message"]</div>
}
<main class="movie-info">
    <div class="main-movie-info">
        <div class="information">
            <div id="info1">
                <h2><b>@Model.Serie.Title</b></h2><br>
                <h6><i>@(((Serie)Model.Serie).Seasons.ToString()) seasons</i></h6>
            </div>

            <div class="ratings">
                <div id="rating">
                    <p><b>RATING:</b> </p>
                    <div class="ratingIMG">
                        <img src="/images/icons8-rating-48.png" alt="img" style="padding:5px">
                        <p>@Model.Serie.Rating /10</p>
                    </div>

                </div>
                <div id="userRating">
                    <p><b>USER RATING:</b> </p>
                    <div class="ratingIMG">
                        <img src="/images/icons8-review-48.png" alt="img" style="padding:5px">
                        @{
                            if (mediaController.GetAllGivenRatings(@Model.Serie.GetId()).Length != 0)
                            {
                                foreach (int rating in mediaController.GetAllGivenRatings(@Model.Serie.GetId()))
                                {
                                    Model.Serie.AddRating(rating);
                                }
                                <p>@Model.Serie.CalculateAverageRating() /10</p>
                            }
                            else
                            {
                                <p>None.</p>
                            }
                        }
                    </div>

                </div>
                <div id="userRatingNr">
                    <p><b>RATINGS NR:</b> </p>
                    <div class="ratingIMG">
                        <img src="/images/icons8-review-50.png" alt="img" style="padding:5px">
                        @{
                            if (mediaController.GetAllGivenRatings(@Model.Serie.GetId()).Length != 0)
                            {
                                foreach (int rating in mediaController.GetAllGivenRatings(@Model.Serie.GetId()))
                                {
                                    Model.Serie.AddRating(rating);
                                }
                                <p>@Model.Serie.GetAllRatings().Length.ToString()</p>
                            }
                            else
                            {
                                <p>None.</p>
                            }
                        }
                    </div>

                </div>

            </div>
            <div></div>
            <p><b>Description:</b></p>
            <p>@Model.Serie.Description</p>
            @{
                string genresString = string.Join(", ", Model.Serie.GetAllGenres());
            }
            <p><b>Genres :</b> @genresString</p>
            <p><b>Cast :</b> @Model.Serie.Cast.ToString()</p>
            <p><b>Country of origin :</b> @Model.Serie.CountryOfOrigin</p>
            <p><b>Seasons : </b>@(((Serie)Model.Serie).Seasons.ToString())</p>
            <p><b>Episodes : </b>@(((Serie)Model.Serie).Episodes.ToString())</p>

            @{
                if (mediaController.GetAllGivenRatings(@Model.Serie.GetId()).Length != 0)
                {
                    foreach (int rating in mediaController.GetAllGivenRatings(@Model.Serie.GetId()))
                    {
                        Model.Serie.AddRating(rating);
                    }
                    <p>
                        <b> User given rating:</b> @Model.Serie.CalculateAverageRating()

                    </p>
                }
                else
                {
                    <p> <b>User given rating:</b> no reviews yet.</p>
                }
            }
        </div>
        <div class="cover">
            <img src="data:image;base64,@mediaController.GetMediaItemImageByID(@Model.Serie.GetId())" alt="Movie cover" style="padding:10px">
        </div>
    </div>
    
    @if (User.Identity.IsAuthenticated)
    {

        <br />
        <div class="mediaButtons">
            <div id="writeReview">
                <a asp-page="/ReviewPage" asp-route-movieId="@Model.Serie.GetId()"><b>Write a review</b></a>
            </div>
            <form method="post">
                <button type="submit" name="serieId" value="@Model.Serie.GetId()"><b>Add to Favorites</b></button>
            </form>
        </div>
        

    }

</main>
